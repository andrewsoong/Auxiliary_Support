# Auxiliary_Support
Complete version v2.2

这是一个辅助支撑项目，主要是HDF的数据处理，入库，出库，画图展示。 Linux + python + Mysql 架构。

此项目大概从2013年11月份开始，当时整个后端的数据处理有我和gm来做，lm负责NCL的画图。因为负责这个项目的甲方非常重视这个项目的延续性，所以提出平台化的需求，即以后如果增加新的仪器，只需要简单的增加对应的配置即可，将处理细节等等都屏蔽掉，所以在平台化这个方向做了许多工作。

关于架构的选择。

1、操作系统选择centos，因为它的稳定性和免费，以及项目成员都比较熟悉。

2、数据库开始选择的是sqlite，看中他的本地性和处理数据的高效性，但是后来发现它所支持的聚合函数不是太多，功能不是太强大，所以后来换成了MySQL；目前的阶段看来，这个选择是正确的，因为处理数据量的庞大，导入导出的频繁，计算的频繁，如果是sqlite，有可能不能支撑，目前MySQL的存储已经占用了1.4T的硬盘。

3、编程语言选择的是Python，因为它的学习成本低，上手较快，主要的是它的科学计算方面的优势，numpy等科学库的方便。

后来因为gm的离职，这个项目就由我和xl两人接着做，因为整个架构都是gm设计的，业务上也都是他和甲方来接触，所以他的离职对于整个项目的影响巨大。太阳依旧升起，生活还要继续，甲方的需求还在增加，任务还是需要完成，因为xl是新加入这个项目，所以一切都要从头学；活多人少，后台数据处理就是我们两个干，为了尽快完成任务，后来的开发过程中，许多地方都抛弃了平台化的工作，在进度和平台化中选择了进度。 此项目还在继续，以后慢慢补充。

项目中的一些需要解决的问题：

1.当Mysql在多线程负载比较高的情况下会出现自动重启的情况。因为机器的硬件是一套曙光的集群，MySQL数据库安装在网络存储盘上 。初步的得出的解释是此网络存储不稳定，造成在高吞量的情况下数据库挂掉。至于是不是这个原因造成的，还是有其他的原因造成的 ，需要有时间好好的研究一下。目前是凑合着使用。 

2.Mysql的纵向扩展，可以一个仪器使用一个数据库。以后需要考虑分开。

3.监控系统需要建立。

下面这个是2014-07-01的时候写的一个总结：

一、做这个项目中的一些体会：

1.通用化的配置文件的使用：充分使用了python中的字典，将一些涉及到仪器等变化的地方改为配置的方式，为以后增加仪器更加方便，为了通用性也是付出了许多心血，效果也是很明显的，系统的扩展性更好。

2.参数的使用：使用了一个开源的docopt.py这种方式，也使得程序更加通用化，参数更加规范化，守护程序处理起来更加方便。

3.守护进程的使用:使用了pid进程号和alive时间这两种机制来保证系统的稳定性。

4.标准化的log记录方式：通过不同的日志级别来监测系统的运行状况，以及程序运行的开始和结束标志，可以实时监测系统的处理步骤和流程，了解系统的目前处理状况，为以后的监测平台提供数据。

5.常用函数写成库函数：把一些系统中经常使用的或者与业务关系不太大的函数都写入到一个文件中，作为通用的库函数使用，方便开发人员的使用、排错，避免重复的制造车轮。

6.关于进程与线程的探索：在追求效率的时候，我们经常会使用多进程和多线程，但是在多线程和多进程的选择中我们还要考虑业务与机器本身的性能的关系，我们从单进程到多进程、多线程再到单进程，这中间通过大量的测试，对于多线程和操作系统本质的讨论，对于机器本身性能的估计，找寻着适合2.158这台机器的最好方案，合适的才是最好的。

7.对于业务流程化的顺序、处理流程中节点的选择、正确性的保证，充分使用了.OK的方式，简单直接有效；也可以很快的对于业务中出现问题后原因的定位。

8.系统没有上业务之前的模拟测试。 

9.系统架构的选择，特别是数据库的选择，对于SQLite和mysql的性能测试。

数据库方面的一些想法： 

目前整个系统可以自动化的运行，能满足上线的基本要求，现在整个系统的瓶颈有两个地方，第一是关于sim的计算比较慢，现在正在改为MPI的方式进行计算，效果还是比较满意的；第二是数据库方面的瓶颈。

一、目前的数据库只有一个主库，假若挂掉，则整个系统都将OVER，风险有点大，可以考虑采取主从的备份架构，建立一个备份的从库。根据系统的业务特点，有些原始数据没有必要备份，那些画图时只依赖当天的数据可以不用备份，可以只备份那个通过计算得出的表，或者是需要画出长序列时间的表；这样也能减轻主库的I/O压力。

二、数据的入库的性能使用load的方式现在还可以接受，但是导出的性能就差强人意了。 

1.最简单的办法就是进行纵向扩展，将不同的仪器放在不同的数据中(前提是对于整个业务系统，各个仪器之间没有任何业务的关联，目前我所知道的信息好像是没有什么联系)，即分别针对MWTS、MWHS、IRAS、MWRI建立四个数据库，各个仪器的业务在对应的各自的数据库中完成，这种方式是最简单、方便、可行、应该优先考虑的选择。 

2.那些导出数据只需要当天的数据的行为可以放在主库上进行，那些导出长序列的数据可以在从库上进行，这样也减轻了主库的部分压力。

2014-11-02 关于系统中数据量的统计：

1.包括L1级数据和OBC数据：例如： FY3C_MWTSX_GBAL_L1_20141020_2305_033KM_MS.HDF FY3C_MWTSX_GBAL_L1_20141020_2305_OBCXX_MS.HDF 
每天： MWTS: 183M; MWHS: 380M; IRAS: 267M; MWRI: 854M 

2.t639原始数据：例如： gmf.639.2014091600000.grb2 
每天：4.7G
所以共： 183M + 380M + 267M+854M + 4.7G = 6.3G
中间过程的生成文件： 1.经过计算过后的两种模式的二进制文件：例如： FY3C_MWTSX_GBAL_L1_20141020_1256_033KM_MS_FWDBTS_T639_CRTM202_TOVSL1X.bin FY3C_MWTSX_GBAL_L1_20141020_1256_033KM_MS_FWDBTS_T639_RTTOV101_TOVSL1X.bin 
每天 : MWTS： 515M MWHS: 1.2G IRAS: 340M MWRI: 3.8G 

2.T639生成的.DAT数据，例如： gmf.639.2014102000018.DAT 每天的数据量：5.5G 

3.导出数据生成的临时HDF数据，目前没有保留，可以忽略 

所以共：515M + 1.2G + 340M +3.8G + 5.5G = 11.3G

Mysql中一天的数据量： FY3C_MWTS_V2：693M; FY3C_MWHS_V2: 1.5G; FY3C_IRAS_V2：780M; FY3C_MWRI_V2：3.8G; 统计表目前一共253M，可以忽略 所以共：693M + 1.5G + 780M + 3.8G = 6.7G

说明：目前的系统中，这三种类型的数据都保留下来了，所以一天的数据量共24.3G; 要是只考虑Mysql数据库的安装盘，每天的数据量为6.7G

代码量统计：到2014-11-25号，Python代码共有3万多行，NCL画图程序没有统计在内。
